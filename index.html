<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Mi Asistente"/>
<meta name="theme-color" content="#0d0d14"/>
<title>Mi Asistente</title>
<link rel="manifest" href="manifest.json"/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
:root{--bg:#0d0d14;--surface:#13131f;--card:#1a1a2e;--border:#252540;--accent:#7c6af5;--accent2:#f5a623;--accent3:#4ecdc4;--danger:#ff6b6b;--text:#f0f0ff;--muted:#6b6b8a;--radius:16px;}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;background:var(--bg);font-family:'Outfit',sans-serif;color:var(--text);}
#app{position:relative;height:100%;display:flex;flex-direction:column;}
header{padding:48px 20px 14px;background:linear-gradient(180deg,rgba(124,106,245,.18)0%,transparent 100%);border-bottom:1px solid var(--border);flex-shrink:0;}
.header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.app-title{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;}
.app-title span{color:var(--accent);}
.date-chip{background:var(--card);border:1px solid var(--border);padding:6px 12px;border-radius:20px;font-size:12px;color:var(--muted);}

/* NOTIF BANNER */
.notif-banner{border-radius:12px;padding:11px 14px;display:flex;align-items:center;gap:10px;margin-bottom:12px;cursor:pointer;border:1px solid rgba(124,106,245,.4);background:rgba(124,106,245,.12);}
.notif-banner.ok{background:rgba(78,205,196,.1);border-color:rgba(78,205,196,.4);cursor:default;}
.notif-banner.no{background:rgba(255,107,107,.1);border-color:rgba(255,107,107,.4);cursor:default;}
.nb-icon{font-size:22px;flex-shrink:0;}
.nb-text{font-size:12px;line-height:1.5;color:var(--muted);}
.nb-text strong{color:var(--text);display:block;}

.next-alarm{background:rgba(124,106,245,.1);border:1px solid rgba(124,106,245,.25);border-radius:10px;padding:7px 12px;font-size:12px;color:var(--accent);display:flex;align-items:center;gap:6px;margin-bottom:12px;}
.next-alarm.hidden{display:none;}

.stats-row{display:flex;gap:8px;margin-bottom:12px;}
.stat-chip{flex:1;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center;}
.stat-num{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;}
.stat-lbl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-top:1px;}
.stat-num.c1{color:var(--accent);}.stat-num.c2{color:var(--danger);}.stat-num.c3{color:var(--accent3);}

.prog-wrap{margin-bottom:14px;}
.prog-label{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px;}
.prog-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden;}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--accent),#a78bfa);border-radius:2px;transition:width .5s;}

.tabs{display:flex;background:var(--card);border-radius:12px;padding:4px;border:1px solid var(--border);gap:0;}
.tab{flex:1;padding:8px 4px;border:none;background:transparent;color:var(--muted);font-family:'Outfit',sans-serif;font-size:12px;font-weight:500;border-radius:9px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:4px;}
.tab.active{background:var(--accent);color:#fff;font-weight:600;}
.tc{background:rgba(255,255,255,.2);border-radius:8px;padding:1px 5px;font-size:10px;}
.tab:not(.active) .tc{background:var(--border);color:var(--muted);}

main{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;scrollbar-width:none;}
main::-webkit-scrollbar{display:none;}

.task-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:13px 14px;display:flex;align-items:flex-start;gap:11px;position:relative;overflow:hidden;animation:sIn .2s ease;}
.task-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;}
.task-card.p-alta::before{background:var(--danger);}
.task-card.p-media::before{background:var(--accent2);}
.task-card.p-baja::before{background:var(--accent3);}
.task-card.done{opacity:.4;}
.task-card.done .ttitle{text-decoration:line-through;}
@keyframes sIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

.chk{width:22px;height:22px;border-radius:50%;border:2px solid var(--border);background:transparent;cursor:pointer;flex-shrink:0;margin-top:2px;display:flex;align-items:center;justify-content:center;color:transparent;font-size:13px;transition:all .2s;}
.task-card.done .chk{background:var(--accent);border-color:var(--accent);color:#fff;}

.tcontent{flex:1;min-width:0;cursor:pointer;}
.ttitle{font-size:15px;font-weight:500;line-height:1.35;margin-bottom:5px;}
.tmeta{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.tcat{font-size:11px;color:var(--muted);background:var(--surface);padding:2px 8px;border-radius:10px;border:1px solid var(--border);}
.ttime{font-size:11px;font-weight:700;padding:2px 8px;border-radius:10px;}
.ttime.upcoming{background:rgba(124,106,245,.15);color:var(--accent);border:1px solid rgba(124,106,245,.3);}
.ttime.soon{background:rgba(245,166,35,.15);color:var(--accent2);border:1px solid rgba(245,166,35,.3);}
.ttime.noww{background:rgba(255,107,107,.2);color:var(--danger);border:1px solid rgba(255,107,107,.4);}
.ttime.past{background:var(--surface);color:var(--muted);border:1px solid var(--border);}
.tdue{font-size:11px;font-weight:500;}
.tdue.hoy{color:var(--accent2);}.tdue.venc{color:var(--danger);}.tdue.fut{color:var(--muted);}
.tnote{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.5;}

.del-btn{background:none;border:none;color:var(--muted);cursor:pointer;padding:4px;font-size:15px;flex-shrink:0;}

.fab{position:fixed;bottom:24px;right:22px;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#a78bfa);border:none;color:#fff;font-size:28px;cursor:pointer;box-shadow:0 8px 30px rgba(124,106,245,.5);display:flex;align-items:center;justify-content:center;z-index:50;transition:transform .15s;}
.fab:active{transform:scale(.9);}

/* ALARM */
.alarm-wrap{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);backdrop-filter:blur(10px);z-index:300;align-items:center;justify-content:center;padding:24px;}
.alarm-wrap.open{display:flex;animation:fIn .3s ease;}
@keyframes fIn{from{opacity:0;}to{opacity:1;}}
.alarm-box{background:var(--surface);border:2px solid var(--danger);border-radius:24px;padding:32px 24px;width:100%;max-width:340px;text-align:center;animation:bIn .4s cubic-bezier(.32,1.4,.5,1);}
@keyframes bIn{from{transform:scale(.7);opacity:0;}to{transform:scale(1);opacity:1;}}
.a-emoji{font-size:56px;margin-bottom:12px;animation:pulse 1s ease infinite;}
@keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.12);}}
.a-head{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--danger);margin-bottom:6px;}
.a-task{font-size:17px;font-weight:600;margin-bottom:6px;}
.a-note{font-size:13px;color:var(--muted);margin-bottom:22px;}
.a-btns{display:flex;gap:10px;}
.btn-snooze{flex:1;background:var(--card);border:1px solid var(--border);color:var(--text);padding:13px;border-radius:12px;cursor:pointer;font-family:'Outfit',sans-serif;font-size:14px;}
.btn-ok{flex:1;background:linear-gradient(135deg,var(--danger),#ff9494);border:none;color:#fff;padding:13px;border-radius:12px;cursor:pointer;font-family:'Outfit',sans-serif;font-weight:700;font-size:14px;}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(6px);z-index:100;align-items:flex-end;justify-content:center;}
.overlay.open{display:flex;animation:fIn .2s ease;}
.modal{background:var(--surface);border-radius:24px 24px 0 0;width:100%;max-width:520px;padding:0 20px 44px;border:1px solid var(--border);border-bottom:none;animation:sUp .3s cubic-bezier(.32,1.2,.5,1);max-height:93vh;overflow-y:auto;scrollbar-width:none;}
.modal::-webkit-scrollbar{display:none;}
@keyframes sUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:16px auto 20px;}
.modal h2{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:20px;}
.field{margin-bottom:16px;}
.field label{display:block;font-size:12px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.08em;margin-bottom:7px;}
.field input,.field textarea,.field select{width:100%;background:var(--card);border:1px solid var(--border);color:var(--text);padding:12px 14px;border-radius:12px;font-size:15px;font-family:'Outfit',sans-serif;-webkit-appearance:none;}
.field input:focus,.field textarea:focus,.field select:focus{outline:none;border-color:var(--accent);}
.field textarea{min-height:70px;resize:vertical;}
.dt-row{display:grid;grid-template-columns:1.4fr 1fr;gap:10px;}
.p-row{display:flex;gap:8px;}
.pb{flex:1;padding:10px 6px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'Outfit',sans-serif;font-size:13px;cursor:pointer;text-align:center;}
.pb.sa{background:rgba(255,107,107,.15);border-color:var(--danger);color:var(--danger);}
.pb.sm{background:rgba(245,166,35,.15);border-color:var(--accent2);color:var(--accent2);}
.pb.sb{background:rgba(78,205,196,.15);border-color:var(--accent3);color:var(--accent3);}
.r-row{display:flex;gap:8px;}
.rb{flex:1;padding:9px 4px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'Outfit',sans-serif;font-size:12px;cursor:pointer;text-align:center;}
.rb.sel{background:rgba(124,106,245,.15);border-color:var(--accent);color:var(--accent);}
.modal-btns{display:flex;gap:10px;margin-top:22px;}
.btn-save{flex:1;background:linear-gradient(135deg,var(--accent),#a78bfa);color:#fff;border:none;padding:14px;border-radius:12px;font-family:'Outfit',sans-serif;font-weight:600;font-size:15px;cursor:pointer;}
.btn-cancel{background:var(--card);border:1px solid var(--border);color:var(--text);padding:14px 18px;border-radius:12px;cursor:pointer;font-size:14px;font-family:'Outfit',sans-serif;}

.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;text-align:center;gap:12px;}
.empty-ico{font-size:48px;opacity:.35;}
.empty-txt{color:var(--muted);font-size:15px;}

.sec-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.sec-title{font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);font-weight:600;}
.clr-btn{background:none;border:none;color:var(--muted);font-size:11px;cursor:pointer;font-family:'Outfit',sans-serif;text-decoration:underline;}

.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:#1a1a2e;border:1px solid var(--border);color:var(--text);padding:10px 20px;border-radius:30px;font-size:13px;opacity:0;transition:all .3s;z-index:200;white-space:nowrap;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="header-top">
      <div class="app-title">Mi<span>Asistente</span></div>
      <div class="date-chip" id="dateChip"></div>
    </div>
    <div id="notifBanner" class="notif-banner">
      <div class="nb-icon">ğŸ””</div>
      <div class="nb-text"><strong>Activar notificaciones</strong>Toca aquÃ­ para recibir alertas de tus tareas</div>
    </div>
    <div class="next-alarm hidden" id="nextAlarmBar">â° <span id="nextAlarmTxt"></span></div>
    <div class="stats-row">
      <div class="stat-chip"><div class="stat-num c1" id="sPend">0</div><div class="stat-lbl">Pendientes</div></div>
      <div class="stat-chip"><div class="stat-num c2" id="sAlta">0</div><div class="stat-lbl">Urgentes</div></div>
      <div class="stat-chip"><div class="stat-num c3" id="sDone">0</div><div class="stat-lbl">Listas âœ“</div></div>
    </div>
    <div class="prog-wrap">
      <div class="prog-label"><span>Progreso de hoy</span><span id="progPct">0%</span></div>
      <div class="prog-bar"><div class="prog-fill" id="progFill" style="width:0%"></div></div>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="todas" onclick="switchTab('todas')">ğŸ“‹ Todas <span class="tc" id="tc0">0</span></button>
      <button class="tab" data-tab="hoy" onclick="switchTab('hoy')">âš¡ Hoy <span class="tc" id="tc1">0</span></button>
      <button class="tab" data-tab="listas" onclick="switchTab('listas')">âœ… Listas <span class="tc" id="tc2">0</span></button>
    </div>
  </header>
  <main id="taskList"></main>
  <button class="fab" onclick="openModal()">ï¼‹</button>
</div>

<!-- ALARMA -->
<div class="alarm-wrap" id="alarmWrap">
  <div class="alarm-box">
    <div class="a-emoji">â°</div>
    <div class="a-head">Â¡Hora de tu tarea!</div>
    <div class="a-task" id="aTask"></div>
    <div class="a-note" id="aNote"></div>
    <div class="a-btns">
      <button class="btn-snooze" onclick="snooze()">ğŸ˜´ +10 min</button>
      <button class="btn-ok" onclick="dismiss()">âœ“ Listo</button>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="overlay" id="overlay" onclick="bgClose(event)">
  <div class="modal">
    <div class="handle"></div>
    <h2 id="mTitle">Nueva Tarea</h2>
    <div class="field"><label>Â¿QuÃ© hay que hacer?</label><input type="text" id="fTitle" placeholder="Nombre de la tarea..." maxlength="100"/></div>
    <div class="field"><label>Nota / Detalle</label><textarea id="fNote" placeholder="Detalles, pasos..."></textarea></div>
    <div class="field"><label>CategorÃ­a</label>
      <select id="fCat">
        <option value="">Sin categorÃ­a</option>
        <option value="ğŸ’¼ Trabajo">ğŸ’¼ Trabajo</option>
        <option value="ğŸ  Casa">ğŸ  Casa</option>
        <option value="ğŸ’° Dinero">ğŸ’° Dinero</option>
        <option value="ğŸ›’ Compras">ğŸ›’ Compras</option>
        <option value="ğŸ“ Llamadas">ğŸ“ Llamadas</option>
        <option value="ğŸ¯ Personal">ğŸ¯ Personal</option>
        <option value="ğŸ“¦ Pedidos">ğŸ“¦ Pedidos</option>
        <option value="ğŸ©º Salud">ğŸ©º Salud</option>
      </select>
    </div>
    <div class="field"><label>Prioridad</label>
      <div class="p-row">
        <button class="pb" data-p="alta" onclick="selP('alta')">ğŸ”´ Alta</button>
        <button class="pb" data-p="media" onclick="selP('media')">ğŸŸ¡ Media</button>
        <button class="pb" data-p="baja" onclick="selP('baja')">ğŸŸ¢ Baja</button>
      </div>
    </div>
    <div class="field"><label>ğŸ“… Fecha y â° Hora</label>
      <div class="dt-row">
        <input type="date" id="fDate"/>
        <input type="time" id="fTime"/>
      </div>
    </div>
    <div class="field"><label>ğŸ” Repetir</label>
      <div class="r-row">
        <button class="rb sel" data-r="no" onclick="selR('no')">Una vez</button>
        <button class="rb" data-r="diario" onclick="selR('diario')">Diario</button>
        <button class="rb" data-r="semanal" onclick="selR('semanal')">Semanal</button>
      </div>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn-save" onclick="saveTask()">Guardar âœ“</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const KEY = 'mi_asistente_tareas';
const KEY_F = 'mi_asistente_fired';

function loadTasks(){
  try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }
  catch(e){ return []; }
}
function saveTasks(){
  try{ localStorage.setItem(KEY, JSON.stringify(tasks)); }
  catch(e){ toast('âš ï¸ Error guardando'); }
}

let tasks = loadTasks();
let editId = null;
let selPriority = 'media';
let selRepeat = 'no';
let curTab = 'todas';
let curAlarm = null;
const fired = new Set(JSON.parse(localStorage.getItem(KEY_F)||'[]'));

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', function(){
  const now = new Date();
  const dias=['Domingo','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado'];
  const mes=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
  document.getElementById('dateChip').textContent = dias[now.getDay()]+', '+now.getDate()+' '+mes[now.getMonth()];
  document.getElementById('fDate').value = todayStr();

  // Notif banner
  setupNotifBanner();

  // Render
  renderAll();

  // Alarm ticker
  setInterval(checkAlarms, 30000);
  checkAlarms();
  setInterval(updateAlarmBar, 60000);
  updateAlarmBar();
});

// â”€â”€ NOTIFICATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupNotifBanner(){
  const b = document.getElementById('notifBanner');
  const perm = (typeof Notification !== 'undefined') ? Notification.permission : 'denied';
  if(perm === 'granted'){
    b.className = 'notif-banner ok';
    b.innerHTML = '<div class="nb-icon">âœ…</div><div class="nb-text"><strong>Notificaciones activadas</strong>RecibirÃ¡s alertas a la hora programada</div>';
  } else if(perm === 'denied'){
    b.className = 'notif-banner no';
    b.innerHTML = '<div class="nb-icon">ğŸš«</div><div class="nb-text"><strong>Notificaciones bloqueadas</strong>Ve a ajustes del navegador y actÃ­valas</div>';
  } else {
    b.className = 'notif-banner';
    b.innerHTML = '<div class="nb-icon">ğŸ””</div><div class="nb-text"><strong>Activar notificaciones</strong>Toca aquÃ­ para recibir alertas de tus tareas</div>';
    b.onclick = askNotif;
  }
}

async function askNotif(){
  if(typeof Notification === 'undefined'){ toast('Tu navegador no soporta notificaciones'); return; }
  const r = await Notification.requestPermission();
  setupNotifBanner();
  if(r === 'granted'){
    toast('ğŸ”” Â¡Notificaciones activadas!');
    try{ new Notification('âœ… Mi Asistente', {body:'Notificaciones funcionando correctamente'}); }catch(e){}
  } else {
    toast('Permiso denegado. ActÃ­valas en ajustes.');
  }
}

// â”€â”€ ALARM CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkAlarms(){
  const now = new Date();
  const td = todayStr();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const hhmm = hh+':'+mm;
  tasks.forEach(t => {
    if(t.done || !t.date || !t.time) return;
    const key = t.id+'_'+t.date+'_'+t.time;
    if(t.date === td && t.time === hhmm && !fired.has(key)){
      fired.add(key);
      localStorage.setItem(KEY_F, JSON.stringify([...fired]));
      triggerAlarm(t);
    }
  });
}

let alarmInterval = null;

function playAlarmSound(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    function beep(freq, start, dur){
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = freq;
      o.type = 'sine';
      g.gain.setValueAtTime(0, ctx.currentTime + start);
      g.gain.linearRampToValueAtTime(0.6, ctx.currentTime + start + 0.05);
      g.gain.linearRampToValueAtTime(0, ctx.currentTime + start + dur);
      o.start(ctx.currentTime + start);
      o.stop(ctx.currentTime + start + dur + 0.05);
    }
    // Alarm pattern: beep beep beep pause
    beep(880, 0,    0.15);
    beep(880, 0.2,  0.15);
    beep(880, 0.4,  0.15);
    beep(1100,0.7,  0.3);
    beep(880, 1.1,  0.15);
    beep(880, 1.3,  0.15);
    beep(1100,1.6,  0.3);
  }catch(e){}
}

function stopAlarmSound(){
  if(alarmInterval){ clearInterval(alarmInterval); alarmInterval=null; }
}

function triggerAlarm(t){
  curAlarm = t;
  document.getElementById('aTask').textContent = t.title;
  document.getElementById('aNote').textContent = t.note || t.cat || '';
  document.getElementById('alarmWrap').classList.add('open');
  // VibraciÃ³n
  if(navigator.vibrate) navigator.vibrate([500,200,500,200,500,200,500]);
  // Sonido â€” repite cada 3 segundos
  playAlarmSound();
  alarmInterval = setInterval(playAlarmSound, 3000);
  // NotificaciÃ³n del sistema
  if(typeof Notification !== 'undefined' && Notification.permission === 'granted'){
    try{ new Notification('â° '+t.title, {body: t.note || t.cat || 'Toca para ver', requireInteraction:true}); }catch(e){}
  }
}

function dismiss(){ stopAlarmSound(); document.getElementById('alarmWrap').classList.remove('open'); curAlarm=null; }
function snooze(){
  stopAlarmSound();
  if(!curAlarm) return;
  const t = tasks.find(x=>x.id===curAlarm.id);
  if(t && t.time){
    const [h,m] = t.time.split(':').map(Number);
    const d = new Date(); d.setHours(h,m+10,0,0);
    t.time = String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
    saveTasks(); renderAll(); updateAlarmBar();
    toast('ğŸ˜´ Pospuesto â†’ '+t.time);
  }
  dismiss();
}

function updateAlarmBar(){
  const now = new Date();
  const up = tasks.filter(t=>!t.done&&t.date&&t.time)
    .map(t=>({...t,dt:new Date(t.date+'T'+t.time)}))
    .filter(t=>t.dt>now).sort((a,b)=>a.dt-b.dt);
  const bar = document.getElementById('nextAlarmBar');
  if(!up.length){ bar.classList.add('hidden'); return; }
  const nx = up[0];
  const diff = Math.round((nx.dt-now)/60000);
  const lbl = diff<60 ? 'en '+diff+' min' : diff<1440 ? 'a las '+nx.time : fmtDate(nx.date)+' a las '+nx.time;
  document.getElementById('nextAlarmTxt').textContent = '"'+nx.title+'" '+lbl;
  bar.classList.remove('hidden');
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function todayStr(){
  const d=new Date();
  return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
}

function renderAll(){ updateStats(); renderTasks(); updateAlarmBar(); }

function getFiltered(){
  const td = todayStr();
  if(curTab==='hoy')    return tasks.filter(t=>!t.done&&(!t.date||t.date<=td));
  if(curTab==='listas') return tasks.filter(t=>t.done);
  return tasks.filter(t=>!t.done);
}

function updateStats(){
  const td=todayStr(), p=tasks.filter(t=>!t.done), d=tasks.filter(t=>t.done);
  document.getElementById('sPend').textContent=p.length;
  document.getElementById('sAlta').textContent=p.filter(t=>t.priority==='alta').length;
  document.getElementById('sDone').textContent=d.length;
  const pct=tasks.length?Math.round(d.length/tasks.length*100):0;
  document.getElementById('progPct').textContent=pct+'%';
  document.getElementById('progFill').style.width=pct+'%';
  document.getElementById('tc0').textContent=p.length;
  document.getElementById('tc1').textContent=tasks.filter(t=>!t.done&&(!t.date||t.date<=td)).length;
  document.getElementById('tc2').textContent=d.length;
}

function getTimeStatus(t){
  if(!t.time) return null;
  const now=new Date(), dt=new Date((t.date||todayStr())+'T'+t.time);
  const diff=Math.round((dt-now)/60000);
  if(diff<-1)  return{c:'past',l:'ğŸ• '+t.time};
  if(diff<=1)  return{c:'noww',l:'ğŸ”” Â¡AHORA!'};
  if(diff<=30) return{c:'soon',l:'âš¡ '+t.time+' ('+diff+'m)'};
  return{c:'upcoming',l:'â° '+t.time};
}

function renderTasks(){
  const list=document.getElementById('taskList');
  const f=getFiltered();
  if(!f.length){
    list.innerHTML='<div class="empty"><div class="empty-ico">'+(curTab==='listas'?'ğŸ†':'ğŸŒŸ')+'</div><div class="empty-txt">'+(curTab==='listas'?'AÃºn no hay completadas':'Sin tareas pendientes')+'<br><small style="opacity:.6">'+(curTab==='listas'?'Completa tareas y aparecerÃ¡n aquÃ­':'Toca ï¼‹ para agregar una')+'</small></div></div>';
    return;
  }
  const sorted=[...f].sort((a,b)=>{
    const po={alta:0,media:1,baja:2};
    if(po[a.priority]!==po[b.priority]) return po[a.priority]-po[b.priority];
    if(a.date&&b.date) return a.date.localeCompare(b.date);
    if(a.date) return -1; if(b.date) return 1;
    return b.id-a.id;
  });
  const td=todayStr();
  let html='';
  if(curTab==='listas') html='<div class="sec-row"><div class="sec-title">Completadas</div><button class="clr-btn" onclick="clearDone()">Borrar todas</button></div>';
  sorted.forEach(t=>{
    let dc='',dt2='';
    if(t.date){
      if(t.date<td){dc='venc';dt2='âš ï¸ Vencida';}
      else if(t.date===td){dc='hoy';dt2='ğŸ“… Hoy';}
      else{dc='fut';dt2='ğŸ“… '+fmtDate(t.date);}
    }
    const ts=getTimeStatus(t);
    const rep=t.repeat&&t.repeat!=='no'?'<span class="tcat">ğŸ” '+t.repeat+'</span>':'';
    html+='<div class="task-card p-'+t.priority+(t.done?' done':'')+'">'+
      '<button class="chk" onclick="toggleDone('+t.id+')">'+(t.done?'âœ“':'')+'</button>'+
      '<div class="tcontent" onclick="editTask('+t.id+')">'+
        '<div class="ttitle">'+esc(t.title)+'</div>'+
        '<div class="tmeta">'+
          (t.cat?'<span class="tcat">'+esc(t.cat)+'</span>':'')+
          (ts?'<span class="ttime '+ts.c+'">'+ts.l+'</span>':'')+
          (!ts&&dt2?'<span class="tdue '+dc+'">'+dt2+'</span>':'')+
          rep+
        '</div>'+
        (t.note?'<div class="tnote">'+esc(t.note)+'</div>':'')+
      '</div>'+
      '<button class="del-btn" onclick="event.stopPropagation();delTask('+t.id+')">ğŸ—‘</button>'+
    '</div>';
  });
  list.innerHTML=html;
}

function fmtDate(d){const[y,m,day]=d.split('-');const ms=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];return day+' '+ms[parseInt(m)-1];}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab){
  curTab=tab;
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab));
  renderTasks();
}

// â”€â”€ TASK ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleDone(id){
  const t=tasks.find(x=>x.id===id); if(!t) return;
  t.done=!t.done;
  if(t.done&&t.repeat&&t.repeat!=='no'){
    const nx={...t,id:Date.now(),done:false};
    const d=new Date(t.date||todayStr());
    if(t.repeat==='diario') d.setDate(d.getDate()+1);
    if(t.repeat==='semanal') d.setDate(d.getDate()+7);
    nx.date=d.toISOString().split('T')[0];
    tasks.push(nx);
    toast('ğŸ” RepeticiÃ³n: '+fmtDate(nx.date));
  }
  saveTasks(); renderAll();
  toast(t.done?'âœ… Â¡Completada!':'â†©ï¸ Pendiente de nuevo');
}

function delTask(id){ tasks=tasks.filter(x=>x.id!==id); saveTasks(); renderAll(); toast('ğŸ—‘ Eliminada'); }
function clearDone(){ tasks=tasks.filter(x=>!x.done); saveTasks(); renderAll(); toast('ğŸ§¹ Limpias'); }

function editTask(id){
  const t=tasks.find(x=>x.id===id); if(!t) return;
  editId=id;
  document.getElementById('fTitle').value=t.title;
  document.getElementById('fNote').value=t.note||'';
  document.getElementById('fCat').value=t.cat||'';
  document.getElementById('fDate').value=t.date||todayStr();
  document.getElementById('fTime').value=t.time||'';
  selPriority=t.priority; selRepeat=t.repeat||'no';
  document.querySelectorAll('.pb').forEach(b=>b.className='pb');
  const pb=document.querySelector('.pb[data-p="'+t.priority+'"]');
  if(pb) pb.classList.add('s'+t.priority[0]);
  document.querySelectorAll('.rb').forEach(b=>b.classList.toggle('sel',b.dataset.r===selRepeat));
  document.getElementById('mTitle').textContent='Editar Tarea';
  document.getElementById('overlay').classList.add('open');
}

// â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(){
  editId=null;
  document.getElementById('fTitle').value='';
  document.getElementById('fNote').value='';
  document.getElementById('fCat').value='';
  document.getElementById('fDate').value=todayStr();
  document.getElementById('fTime').value='';
  selPriority='media'; selRepeat='no';
  document.querySelectorAll('.pb').forEach(b=>b.className='pb');
  document.querySelector('.pb[data-p="media"]').classList.add('sm');
  document.querySelectorAll('.rb').forEach(b=>b.classList.toggle('sel',b.dataset.r==='no'));
  document.getElementById('mTitle').textContent='Nueva Tarea';
  document.getElementById('overlay').classList.add('open');
  setTimeout(()=>document.getElementById('fTitle').focus(),300);
}
function closeModal(){ document.getElementById('overlay').classList.remove('open'); }
function bgClose(e){ if(e.target===document.getElementById('overlay')) closeModal(); }

function selP(p){
  selPriority=p;
  document.querySelectorAll('.pb').forEach(b=>b.className='pb');
  const map={alta:'sa',media:'sm',baja:'sb'};
  document.querySelector('.pb[data-p="'+p+'"]').classList.add(map[p]);
}
function selR(r){ selRepeat=r; document.querySelectorAll('.rb').forEach(b=>b.classList.toggle('sel',b.dataset.r===r)); }

function saveTask(){
  const title=document.getElementById('fTitle').value.trim();
  if(!title){ toast('âš ï¸ Escribe el nombre de la tarea'); return; }
  const data={
    title,
    note:document.getElementById('fNote').value.trim(),
    cat:document.getElementById('fCat').value,
    priority:selPriority,
    date:document.getElementById('fDate').value,
    time:document.getElementById('fTime').value,
    repeat:selRepeat,
    done:false
  };
  if(editId){
    Object.assign(tasks.find(x=>x.id===editId), data);
    toast('âœï¸ Tarea actualizada');
  } else {
    tasks.push({id:Date.now(), ...data, created:new Date().toISOString()});
    toast(data.time ? 'âœ… Guardada Â· alarma '+data.time : 'âœ… Tarea guardada');
  }
  saveTasks(); closeModal(); renderAll();
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2600);
}

document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModal(); });
</script>
</body>
</html>
