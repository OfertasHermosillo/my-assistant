<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Mis H√°bitos"/>
<meta name="theme-color" content="#0d0d14"/>
<title>Mis H√°bitos</title>
<link rel="manifest" href="manifest.json"/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
:root{--bg:#0d0d14;--surface:#13131f;--card:#1a1a2e;--border:#252540;--accent:#7c6af5;--accent2:#f5a623;--accent3:#4ecdc4;--danger:#ff6b6b;--text:#f0f0ff;--muted:#6b6b8a;--radius:16px;}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;background:var(--bg);font-family:'Outfit',sans-serif;color:var(--text);overflow:hidden;}

/* VIEWS */
.view{position:fixed;inset:0;display:flex;flex-direction:column;background:var(--bg);transition:transform .3s cubic-bezier(.32,1,.5,1);overflow:hidden;}
.view.hidden{transform:translateX(100%);pointer-events:none;}

/* HEADER */
.hdr{padding:52px 20px 14px;background:linear-gradient(180deg,rgba(124,106,245,.18)0%,transparent 100%);border-bottom:1px solid var(--border);flex-shrink:0;}
.hdr-row{display:flex;align-items:center;justify-content:space-between;}
.app-title{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;}
.app-title span{color:var(--accent);}
.back-btn{display:flex;align-items:center;gap:8px;background:none;border:none;color:var(--accent);font-family:'Outfit',sans-serif;font-size:15px;font-weight:600;cursor:pointer;padding:4px 0;}

/* LIST VIEW */
.list-scroll{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;padding-bottom:100px;scrollbar-width:none;}
.list-scroll::-webkit-scrollbar{display:none;}

/* HABIT ROW */
.habit-row{
  background:var(--card);border:1px solid var(--border);border-radius:18px;
  padding:16px;display:flex;align-items:center;gap:14px;cursor:pointer;
  transition:transform .15s,box-shadow .15s;animation:sIn .25s ease;
  position:relative;overflow:hidden;
}
.habit-row::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;border-radius:4px 0 0 4px;}
.habit-row:active{transform:scale(.97);}
@keyframes sIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

.row-emoji{font-size:28px;flex-shrink:0;}
.row-info{flex:1;min-width:0;}
.row-name{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;margin-bottom:4px;}
.row-sub{display:flex;align-items:center;gap:10px;}
.row-streak{font-size:12px;font-weight:600;}
.row-pct{font-size:12px;color:var(--muted);}

/* MINI PROGRESS */
.mini-prog{height:4px;background:var(--border);border-radius:2px;overflow:hidden;margin-top:7px;}
.mini-fill{height:100%;border-radius:2px;transition:width .4s;}

.row-arrow{color:var(--muted);font-size:18px;flex-shrink:0;}
.row-actions{display:flex;gap:4px;flex-shrink:0;}
.row-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;padding:6px;border-radius:8px;}

/* EMPTY */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;text-align:center;gap:14px;padding:40px 20px;}
.empty-ico{font-size:56px;opacity:.3;}
.empty-txt{color:var(--muted);font-size:15px;line-height:1.7;}

/* FAB */
.fab{position:fixed;bottom:24px;right:22px;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#a78bfa);border:none;color:#fff;font-size:28px;cursor:pointer;box-shadow:0 8px 30px rgba(124,106,245,.5);display:flex;align-items:center;justify-content:center;z-index:50;transition:transform .15s;}
.fab:active{transform:scale(.9);}

/* ‚îÄ‚îÄ CALENDAR VIEW ‚îÄ‚îÄ */
.cal-hdr{padding:52px 20px 12px;border-bottom:1px solid var(--border);flex-shrink:0;}
.cal-hdr-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.cal-habit-name{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;}

.month-nav{display:flex;align-items:center;gap:10px;}
.mn-btn{background:var(--card);border:1px solid var(--border);color:var(--text);width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.mn-label{font-size:14px;font-weight:600;min-width:120px;text-align:center;}

/* STATS ROW */
.cal-stats{display:flex;gap:8px;margin-top:10px;}
.cstat{flex:1;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:9px;text-align:center;}
.cstat-num{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;}
.cstat-lbl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-top:1px;}

.cal-scroll{flex:1;overflow-y:auto;padding:14px 14px 60px;scrollbar-width:none;}
.cal-scroll::-webkit-scrollbar{display:none;}

/* CALENDAR */
.cal-days-hdr{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:5px;}
.cdl{text-align:center;font-size:11px;color:var(--muted);font-weight:600;padding:3px 0;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;}
.cday{
  height:42px;border-radius:10px;border:1px solid var(--border);
  background:var(--surface);display:flex;align-items:center;justify-content:center;
  font-size:14px;font-weight:500;cursor:pointer;position:relative;
  transition:all .15s;color:var(--muted);
}
.cday:active{transform:scale(.85);}
.cday.empty{background:transparent;border-color:transparent;cursor:default;}
.cday.today{border-color:var(--accent);color:var(--text);font-weight:700;}
.cday.done{color:#fff;font-weight:700;}
.cday.done::after{content:'‚úì';position:absolute;bottom:2px;right:4px;font-size:9px;opacity:.9;}
.cday.future{opacity:.25;cursor:default;}

/* PROGRESS BAR */
.cal-prog-wrap{margin-top:14px;}
.cal-prog-label{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px;}
.cal-prog-bar{height:6px;background:var(--border);border-radius:3px;overflow:hidden;}
.cal-prog-fill{height:100%;border-radius:3px;transition:width .5s;}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);z-index:200;align-items:flex-end;justify-content:center;}
.overlay.open{display:flex;animation:fIn .2s ease;}
@keyframes fIn{from{opacity:0;}to{opacity:1;}}
.modal{background:var(--surface);border-radius:24px 24px 0 0;width:100%;max-width:520px;padding:0 20px 44px;border:1px solid var(--border);border-bottom:none;animation:sUp .3s cubic-bezier(.32,1.2,.5,1);max-height:90vh;overflow-y:auto;scrollbar-width:none;}
.modal::-webkit-scrollbar{display:none;}
@keyframes sUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:16px auto 20px;}
.modal h2{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:20px;}
.field{margin-bottom:16px;}
.field label{display:block;font-size:12px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.08em;margin-bottom:7px;}
.field input{width:100%;background:var(--card);border:1px solid var(--border);color:var(--text);padding:12px 14px;border-radius:12px;font-size:15px;font-family:'Outfit',sans-serif;-webkit-appearance:none;}
.field input:focus{outline:none;border-color:var(--accent);}
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:6px;}
.eo{height:40px;border-radius:10px;border:1px solid var(--border);background:var(--card);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.eo.sel{border-color:var(--accent);background:rgba(124,106,245,.2);}
.color-row{display:flex;gap:10px;flex-wrap:wrap;}
.co{width:36px;height:36px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all .15s;}
.co.sel{border-color:#fff;transform:scale(1.18);}
.modal-btns{display:flex;gap:10px;margin-top:22px;}
.btn-save{flex:1;background:linear-gradient(135deg,var(--accent),#a78bfa);color:#fff;border:none;padding:14px;border-radius:12px;font-family:'Outfit',sans-serif;font-weight:600;font-size:15px;cursor:pointer;}
.btn-cancel{background:var(--card);border:1px solid var(--border);color:var(--text);padding:14px 18px;border-radius:12px;cursor:pointer;font-size:14px;font-family:'Outfit',sans-serif;}

/* CONFIRM */
.conf-wrap{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(6px);z-index:300;align-items:center;justify-content:center;padding:24px;}
.conf-wrap.open{display:flex;}
.conf-box{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:24px;width:100%;max-width:300px;text-align:center;}
.conf-box h3{font-family:'Syne',sans-serif;font-size:18px;margin-bottom:8px;}
.conf-box p{font-size:13px;color:var(--muted);margin-bottom:20px;}
.conf-btns{display:flex;gap:10px;}
.btn-del{flex:1;background:var(--danger);color:#fff;border:none;padding:12px;border-radius:12px;cursor:pointer;font-family:'Outfit',sans-serif;font-weight:700;}
.btn-no{flex:1;background:var(--card);border:1px solid var(--border);color:var(--text);padding:12px;border-radius:12px;cursor:pointer;font-family:'Outfit',sans-serif;}

.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:#1a1a2e;border:1px solid var(--border);color:var(--text);padding:10px 20px;border-radius:30px;font-size:13px;opacity:0;transition:all .3s;z-index:400;white-space:nowrap;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ VISTA LISTA ‚îÄ‚îÄ -->
<div class="view" id="listView">
  <div class="hdr">
    <div class="hdr-row">
      <div class="app-title">Mis<span>H√°bitos</span></div>
      <div style="font-size:13px;color:var(--muted)" id="listSubtitle"></div>
    </div>
  </div>
  <div class="list-scroll" id="habitList"></div>
  <button class="fab" onclick="openModal()">Ôºã</button>
</div>

<!-- ‚îÄ‚îÄ VISTA CALENDARIO ‚îÄ‚îÄ -->
<div class="view hidden" id="calView">
  <div class="cal-hdr">
    <div class="cal-hdr-top">
      <button class="back-btn" onclick="goBack()">‚Äπ Mis H√°bitos</button>
      <div style="display:flex;gap:8px;">
        <button class="row-btn" onclick="editCurrentHabit()">‚úèÔ∏è</button>
        <button class="row-btn" onclick="askDeleteCurrent()">üóë</button>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
      <span id="calEmoji" style="font-size:26px"></span>
      <span class="cal-habit-name" id="calName"></span>
    </div>
    <div class="month-nav" style="justify-content:center;">
      <button class="mn-btn" onclick="changeMonth(-1)">‚Äπ</button>
      <div class="mn-label" id="monthLabel"></div>
      <button class="mn-btn" onclick="changeMonth(1)">‚Ä∫</button>
    </div>
    <div class="cal-stats" id="calStats"></div>
  </div>
  <div class="cal-scroll" id="calGrid"></div>
</div>

<!-- MODAL -->
<div class="overlay" id="overlay" onclick="bgClose(event)">
  <div class="modal">
    <div class="handle"></div>
    <h2 id="mTitle">Nuevo H√°bito</h2>
    <div class="field"><label>Nombre</label><input type="text" id="fName" placeholder="Ej: Vitaminas, Ejercicio..." maxlength="40"/></div>
    <div class="field"><label>√çcono</label><div class="emoji-grid" id="emojiGrid"></div></div>
    <div class="field"><label>Color</label><div class="color-row" id="colorRow"></div></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn-save" onclick="saveHabit()">Guardar ‚úì</button>
    </div>
  </div>
</div>

<!-- CONFIRMAR BORRAR -->
<div class="conf-wrap" id="confWrap">
  <div class="conf-box">
    <h3>¬øBorrar h√°bito?</h3>
    <p>Se perder√° todo el progreso registrado.</p>
    <div class="conf-btns">
      <button class="btn-no" onclick="closeConf()">Cancelar</button>
      <button class="btn-del" onclick="doDelete()">Borrar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const KEY = 'habitos_v2';
function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(e){ return []; } }
function save(){ localStorage.setItem(KEY, JSON.stringify(habits)); }

let habits = load();
let curHabitId = null;
let editId = null;
let deleteId = null;
let selEmoji = 'üíä';
let selColor = 'morado';
let curYear = new Date().getFullYear();
let curMonth = new Date().getMonth();

const COLORS = {morado:'#7c6af5',verde:'#4ecdc4',rojo:'#ff6b6b',amarillo:'#f5a623',rosa:'#f472b6',azul:'#38bdf8',naranja:'#fb923c'};
const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const EMOJIS = ['üíä','üèãÔ∏è','ü•ó','üíß','üßò','üìö','üö∂','üò¥','üß¥','üéØ','‚úÖ','üåü','üî•','üí™','üß†','ü´Ä','üèÉ','üçé','‚òï','üß™','üåø','üèä','üö¥','üéµ'];
const DSHORT = ['Lu','Ma','Mi','Ju','Vi','Sa','Do'];

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', ()=>{
  buildPickers();
  renderList();
});

// ‚îÄ‚îÄ LIST VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderList(){
  const list = document.getElementById('habitList');
  const sub = document.getElementById('listSubtitle');
  sub.textContent = habits.length ? habits.length+' h√°bito'+(habits.length>1?'s':'') : '';

  if(!habits.length){
    list.innerHTML = '<div class="empty"><div class="empty-ico">üìÖ</div><div class="empty-txt">A√∫n no tienes h√°bitos<br><small style="opacity:.7">Toca Ôºã para agregar uno<br>Vitaminas, Ejercicio, Agua...</small></div></div>';
    return;
  }

  const today = new Date();
  const mk = today.getFullYear()+'-'+String(today.getMonth()+1).padStart(2,'0');
  const daysInMonth = new Date(today.getFullYear(), today.getMonth()+1, 0).getDate();

  list.innerHTML = habits.map(h => {
    const done = h.logs&&h.logs[mk] ? Object.keys(h.logs[mk]).filter(k=>h.logs[mk][k]).length : 0;
    const pct = Math.round(done/daysInMonth*100);
    const streak = getStreak(h);
    const color = COLORS[h.color||'morado'];
    const todayKey = String(today.getDate()).padStart(2,'0');
    const doneToday = h.logs&&h.logs[mk]&&h.logs[mk][todayKey];
    return `
    <div class="habit-row" style="--row-color:${color}" onclick="openCalendar('${h.id}')">
      <div style="position:absolute;left:0;top:0;bottom:0;width:4px;background:${color};border-radius:4px 0 0 4px;"></div>
      <div class="row-emoji">${h.emoji||'‚úÖ'}</div>
      <div class="row-info">
        <div class="row-name">${esc(h.name)}</div>
        <div class="row-sub">
          ${streak>0?`<span class="row-streak" style="color:${color}">üî• ${streak}d seguidos</span>`:'<span class="row-pct">Sin racha a√∫n</span>'}
          <span class="row-pct">${done}/${daysInMonth} d√≠as ¬∑ ${pct}%</span>
          ${doneToday?`<span style="font-size:11px;color:var(--accent3);font-weight:600">‚úì Hoy</span>`:''}
        </div>
        <div class="mini-prog"><div class="mini-fill" style="width:${pct}%;background:${color}"></div></div>
      </div>
      <div style="display:flex;gap:2px;align-items:center;">
        <button class="row-btn" onclick="event.stopPropagation();editHabit('${h.id}')">‚úèÔ∏è</button>
        <button class="row-btn" onclick="event.stopPropagation();askDelete('${h.id}')">üóë</button>
        <span class="row-arrow">‚Ä∫</span>
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ CALENDAR VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openCalendar(id){
  curHabitId = id;
  curYear = new Date().getFullYear();
  curMonth = new Date().getMonth();
  renderCalendar();
  document.getElementById('listView').classList.add('hidden');
  document.getElementById('calView').classList.remove('hidden');
}

function goBack(){
  document.getElementById('calView').classList.add('hidden');
  document.getElementById('listView').classList.remove('hidden');
  renderList();
}

function changeMonth(dir){
  curMonth += dir;
  if(curMonth>11){curMonth=0;curYear++;}
  if(curMonth<0){curMonth=11;curYear--;}
  renderCalendar();
}

function renderCalendar(){
  const h = habits.find(x=>x.id===curHabitId);
  if(!h) return;
  const color = COLORS[h.color||'morado'];

  document.getElementById('calEmoji').textContent = h.emoji||'‚úÖ';
  document.getElementById('calName').textContent = h.name;
  document.getElementById('monthLabel').textContent = MONTHS[curMonth]+' '+curYear;

  const today = new Date();
  const isNow = (curYear===today.getFullYear()&&curMonth===today.getMonth());
  const daysInMonth = new Date(curYear, curMonth+1, 0).getDate();
  const mk = curYear+'-'+String(curMonth+1).padStart(2,'0');
  const doneDays = h.logs&&h.logs[mk] ? Object.keys(h.logs[mk]).filter(k=>h.logs[mk][k]).length : 0;
  const pct = Math.round(doneDays/daysInMonth*100);
  const streak = getStreak(h);

  // Stats
  document.getElementById('calStats').innerHTML = `
    <div class="cstat"><div class="cstat-num" style="color:${color}">${doneDays}</div><div class="cstat-lbl">Completados</div></div>
    <div class="cstat"><div class="cstat-num" style="color:${color}">${daysInMonth-doneDays}</div><div class="cstat-lbl">Pendientes</div></div>
    <div class="cstat"><div class="cstat-num" style="color:var(--accent2)">${streak}</div><div class="cstat-lbl">üî• Racha</div></div>
  `;

  // Grid
  let firstDay = new Date(curYear, curMonth, 1).getDay();
  firstDay = firstDay===0 ? 6 : firstDay-1;

  let cells = DSHORT.map(d=>`<div class="cdl">${d}</div>`).join('');
  let grid = '';
  for(let i=0;i<firstDay;i++) grid+='<div class="cday empty"></div>';
  for(let d=1;d<=daysInMonth;d++){
    const dk = String(d).padStart(2,'0');
    const isDone = h.logs&&h.logs[mk]&&h.logs[mk][dk];
    const isToday = isNow&&d===today.getDate();
    const isFuture = isNow&&d>today.getDate();
    let cls='cday';
    if(isDone) cls+=' done';
    else if(isFuture) cls+=' future';
    if(isToday&&!isDone) cls+=' today';
    const bgStyle = isDone ? `style="background:${color};border-color:${color}"` : '';
    grid+=`<div class="${cls}" ${bgStyle} onclick="toggleDay('${mk}','${dk}')">${d}</div>`;
  }

  document.getElementById('calGrid').innerHTML = `
    <div class="cal-days-hdr">${cells}</div>
    <div class="cal-grid">${grid}</div>
    <div class="cal-prog-wrap">
      <div class="cal-prog-label"><span>Progreso del mes</span><span style="color:${color};font-weight:700">${pct}%</span></div>
      <div class="cal-prog-bar"><div class="cal-prog-fill" style="width:${pct}%;background:${color}"></div></div>
    </div>
    <div style="text-align:center;margin-top:16px;font-size:13px;color:var(--muted)">Total: <strong style="color:var(--text)">${doneDays} de ${daysInMonth} d√≠as</strong></div>
  `;
}

function toggleDay(mk, dk){
  const today = new Date();
  const isNow = (curYear===today.getFullYear()&&curMonth===today.getMonth());
  if(isNow && parseInt(dk)>today.getDate()) return;
  const h = habits.find(x=>x.id===curHabitId);
  if(!h) return;
  if(!h.logs) h.logs={};
  if(!h.logs[mk]) h.logs[mk]={};
  h.logs[mk][dk] = !h.logs[mk][dk];
  if(!h.logs[mk][dk]) delete h.logs[mk][dk];
  save();
  renderCalendar();
  const done = h.logs[mk]&&h.logs[mk][dk];
  if(done) toast('‚úÖ ¬°Marcado!');
}

// ‚îÄ‚îÄ STREAK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getStreak(h){
  if(!h.logs) return 0;
  let streak=0, d=new Date();
  for(let i=0;i<365;i++){
    const mk=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
    const dk=String(d.getDate()).padStart(2,'0');
    if(h.logs[mk]&&h.logs[mk][dk]) streak++;
    else if(i===0){/* today not done yet */}
    else break;
    d.setDate(d.getDate()-1);
  }
  return streak;
}

// ‚îÄ‚îÄ PICKERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildPickers(){
  document.getElementById('emojiGrid').innerHTML = EMOJIS.map(e=>
    `<button class="eo${e===selEmoji?' sel':''}" data-e="${e}" onclick="pickEmoji('${e}')">${e}</button>`
  ).join('');
  document.getElementById('colorRow').innerHTML = Object.entries(COLORS).map(([k,v])=>
    `<div class="co${k===selColor?' sel':''}" data-c="${k}" style="background:${v}" onclick="pickColor('${k}')"></div>`
  ).join('');
}
function pickEmoji(e){ selEmoji=e; document.querySelectorAll('.eo').forEach(b=>b.classList.toggle('sel',b.dataset.e===e)); }
function pickColor(c){ selColor=c; document.querySelectorAll('.co').forEach(b=>b.classList.toggle('sel',b.dataset.c===c)); }

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(){
  editId=null; selEmoji='üíä'; selColor='morado';
  document.getElementById('fName').value='';
  buildPickers();
  document.getElementById('mTitle').textContent='Nuevo H√°bito';
  document.getElementById('overlay').classList.add('open');
  setTimeout(()=>document.getElementById('fName').focus(),300);
}
function editHabit(id){
  const h=habits.find(x=>x.id===id); if(!h) return;
  editId=id; selEmoji=h.emoji||'üíä'; selColor=h.color||'morado';
  document.getElementById('fName').value=h.name;
  buildPickers();
  document.getElementById('mTitle').textContent='Editar H√°bito';
  document.getElementById('overlay').classList.add('open');
}
function editCurrentHabit(){ editHabit(curHabitId); }
function closeModal(){ document.getElementById('overlay').classList.remove('open'); }
function bgClose(e){ if(e.target===document.getElementById('overlay')) closeModal(); }
function saveHabit(){
  const name=document.getElementById('fName').value.trim();
  if(!name){ toast('‚ö†Ô∏è Escribe el nombre'); return; }
  if(editId){
    const h=habits.find(x=>x.id===editId);
    h.name=name; h.emoji=selEmoji; h.color=selColor;
    toast('‚úèÔ∏è Actualizado');
  } else {
    habits.push({id:'h'+Date.now(),name,emoji:selEmoji,color:selColor,logs:{},created:new Date().toISOString()});
    toast('üéØ H√°bito creado');
  }
  save(); closeModal();
  if(document.getElementById('calView').classList.contains('hidden')) renderList();
  else renderCalendar();
  renderList();
}

// ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function askDelete(id){ deleteId=id; document.getElementById('confWrap').classList.add('open'); }
function askDeleteCurrent(){ askDelete(curHabitId); }
function closeConf(){ document.getElementById('confWrap').classList.remove('open'); deleteId=null; }
function doDelete(){
  habits=habits.filter(x=>x.id!==deleteId);
  save(); closeConf();
  if(deleteId===curHabitId) goBack();
  else renderList();
  toast('üóë Eliminado');
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2400); }
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModal(); });
</script>
</body>
</html>
